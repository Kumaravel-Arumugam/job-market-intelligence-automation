{
  "name": "Job Market Intelligence Pipeline",
  "nodes": [
    {
      "parameters": {
        "content": "## TELEGRAM TRIGGER & GLOBAL CHECK\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n**What Happens:**\nThe entry point of the pipeline:\n\n1. Receives messages/callbacks from Telegram users\n2. Checks if system is globally locked (another scrape running)\n3. Retrieves user session state from database\n\n**Protection:** Prevents multiple simultaneous scrape operations\n\n**Output:** User session state + input data ready for routing\\\n\n",
        "height": 640,
        "width": 1088,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -1536
      ],
      "id": "sticky-trigger-global",
      "name": "Trigger & Global Check Note"
    },
    {
      "parameters": {
        "content": "## CENTRAL ROUTING ENGINE\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n**What Happens:**\nThe brain of the workflow that routes user actions:\n\n**Routes Handled:**\n- SHOW_MENU: Display role selection menu\n- UPDATE_TO_MENU: Edit existing message to menu\n- ASK_CUSTOM_ROLE: Prompt for custom job role\n- SEND_LOCKED_MESSAGE: System busy notification\n- CANCEL_OPERATION: User cancelled\n- START_SCRAPE_JOB: Begin data collection\n\n**State Machine:** Manages IDLE, AWAITING_CUSTOM_ROLE, SCRAPING_IN_PROGRESS states\n\n**Output:** Route decision for Switch node to execute",
        "height": 628,
        "width": 688,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2112,
        -1536
      ],
      "id": "sticky-routing",
      "name": "Central Routing Note"
    },
    {
      "parameters": {
        "content": "## USER INTERFACE HANDLERS\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n**What Happens:**\nHandles all Telegram UI interactions:\n\n**Menu Actions:**\n- Send Role Menu: Display job role buttons\n- Update to Main Menu: Edit message in-place\n- Ask Custom Role: Prompt text input\n\n**Status Messages:**\n- Send Locked Message: System busy\n- Notify Cancelled: Operation cancelled\n\n**State Updates:** Each UI action updates user session state in PostgreSQL\n\n**Output:** Telegram messages with inline keyboards\n\n",
        "height": 1520,
        "width": 704,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1296,
        -1776
      ],
      "id": "sticky-ui",
      "name": "UI Handlers Note"
    },
    {
      "parameters": {
        "content": "## WEB SCRAPING ENGINE\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n**What Happens:**\nSelenium-based job scraping from Naukri.com:\n\n**Process:**\n1. Work Generator creates 60 tasks (3 pages x 20 jobs)\n2. Loop Over Items processes sequentially\n3. Python/Selenium navigates to job listings\n4. Extracts: title, company, salary, skills, description\n5. Follows links for full job details\n\n**Error Handling:**\n- Timeout protection per request\n- Error output for failed scrapes\n- User notification on completion\n\n**Output:** Job data saved to PostgreSQL with user chat_id",
        "height": 932,
        "width": 1328,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3120,
        -224
      ],
      "id": "sticky-scraping",
      "name": "Web Scraping Note"
    },
    {
      "parameters": {
        "content": "## DATA STORAGE & BACKUP\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n**What Happens:**\nManages job data persistence:\n\n**Storage Flow:**\n1. Filter valid jobs (Is Not Empty)\n2. Save to job_postings table with chat_id\n3. On completion, backup to backup_job_postings\n4. Assign unique reference_id for batch\n5. Delete processed jobs after analysis\n\n**User Isolation:** Each user data stored with their Telegram chat_id\n\n**Output:** Reference ID for user to track their analysis batch",
        "height": 932,
        "width": 1280,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1760,
        -224
      ],
      "id": "sticky-storage",
      "name": "Data Storage Note"
    },
    {
      "parameters": {
        "content": "## ANALYSIS TRIGGER\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n**What Happens:**\nConnects to the Analysis Engine sub-workflow:\n\n1. After backup, triggers Job Market Analysis Engine\n2. Passes telegram_chat_id and role_name\n3. Deletes original job_postings for this user/role\n4. Analysis Engine runs independently\n\n**Sub-Workflow:** GDeQD6XpAGoHASTo\n\n**Output:** Analysis report sent via Telegram by sub-workflow",
        "height": 644,
        "width": 560,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1056,
        48
      ],
      "id": "sticky-analysis-trigger",
      "name": "Analysis Trigger Note"
    },
    {
      "parameters": {
        "updates": [
          "callback_query",
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -3152,
        -1296
      ],
      "id": "662f9841-5b02-460d-9818-9560e574d712",
      "name": "Telegram Trigger",
      "webhookId": "de5b9fbd-6c75-4ca3-ada9-5a48430ca64c",
      "credentials": {
        "telegramApi": {
          "id": "YgUKoloc6u1XLWhU",
          "name": "job analyst"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "text": "**JOB MARKET INTELLIGENCE**\n\nSelect a target job role to begin the analysis:",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Business Analyst",
                    "additionalFields": {
                      "callback_data": "business-analyst"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Data Analyst",
                    "additionalFields": {
                      "callback_data": "data-analyst"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Analytics Engineer",
                    "additionalFields": {
                      "callback_data": "analytics-engineer"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Automation Engineer",
                    "additionalFields": {
                      "callback_data": "automation-engineer"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Biz Auto Specialist",
                    "additionalFields": {
                      "callback_data": "business-automation-specialist"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Fintech Data Analyst",
                    "additionalFields": {
                      "callback_data": "fintech-data-analyst"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Tech Product Analyst",
                    "additionalFields": {
                      "callback_data": "technical-product-analyst"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Enter Custom Role...",
                    "additionalFields": {
                      "callback_data": "custom_role"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Close",
                    "additionalFields": {
                      "callback_data": "cancel"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1008,
        -1712
      ],
      "id": "d9a0af35-96e1-4595-91ff-69efe69f2928",
      "name": "Send Role Menu",
      "webhookId": "6a6ef03f-b8ca-40fe-9cc6-d82210ed6175",
      "credentials": {
        "telegramApi": {
          "id": "YgUKoloc6u1XLWhU",
          "name": "job analyst"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO user_sessions (chat_id, current_state, collected_data)\nVALUES (\n  {{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }}, \n  'IDLE', \n  '{}'\n)\nON CONFLICT (chat_id) \nDO UPDATE SET current_state = 'IDLE', collected_data = '{}';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1232,
        -1712
      ],
      "id": "6889cd6a-b226-4323-beed-36ad0d11a905",
      "name": "Reset State (IDLE)",
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE user_sessions SET current_state = 'AWAITING_CUSTOM_ROLE' WHERE chat_id = {{ $('Telegram Trigger').item.json.callback_query.message.chat.id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1232,
        -1344
      ],
      "id": "8abad894-afd4-4463-b5c0-5a65c7bd527c",
      "name": "Set State: Awaiting Input",
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "messageId": "={{ $('Telegram Trigger').item.json.callback_query.message.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "âœï¸ **CUSTOM SEARCH**\n\nPlease type the **Job Role** you want to analyze.\n_(e.g., 'React Developer', 'Marketing Manager')_",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Back to Menu",
                    "additionalFields": {
                      "callback_data": "menu2"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1008,
        -1344
      ],
      "id": "cf074518-506b-4c29-9a3e-b9370e85b260",
      "name": "Ask Custom Role (UI)",
      "webhookId": "399109f9-511c-4414-8037-e6fc1c3e7a61",
      "credentials": {
        "telegramApi": {
          "id": "YgUKoloc6u1XLWhU",
          "name": "job analyst"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE user_sessions SET current_state = 'SCRAPING_IN_PROGRESS', updated_at = NOW() WHERE chat_id = {{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1232,
        -784
      ],
      "id": "27233e98-910a-4dff-adcc-603164e03a0e",
      "name": "Set State: Scraping In Progress",
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "text": "=âœ… You have selected to analyze: **{{ $('Switch Route').item.json.role_name }}**\n\nðŸš€ **Analysis has been started.**\n\nYou will be notified upon completion. ðŸ””",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1008,
        -784
      ],
      "id": "70632fff-12ed-46cd-b7f7-d3d7722d975b",
      "name": "Send Confirmation Message",
      "webhookId": "361366ec-d4a7-4219-8c1b-180018804fc3",
      "credentials": {
        "telegramApi": {
          "id": "YgUKoloc6u1XLWhU",
          "name": "job analyst"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "text": "âš ï¸ **SYSTEM BUSY**\n\nAn analysis operation for you is currently in progress.\n\nðŸ”’ _Input is temporarily locked._\n\nðŸ”” _You will be notified automatically when the process completes._",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1232,
        -1152
      ],
      "id": "c8d571ba-1eb5-4077-8ea2-e38c7a73e7ff",
      "name": "Send Locked Message",
      "webhookId": "61d3483d-76d8-4a47-ab23-bb407e0f1885",
      "credentials": {
        "telegramApi": {
          "id": "YgUKoloc6u1XLWhU",
          "name": "job analyst"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE user_sessions \nSET \n  current_state = 'SCRAPING_IN_PROGRESS',\n  collected_data = collected_data || jsonb_build_object('lock_expiry', (NOW() + INTERVAL '1 hour')),\n  updated_at = NOW()\nWHERE chat_id = {{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -768,
        -784
      ],
      "id": "a2df09aa-bef2-40ff-b11d-e1e5e9ace91b",
      "name": "Set State: Scraping (1 Hour Lock)",
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "language": "pythonNative",
        "pythonCode": "from selenium import webdriver\nfrom selenium.webdriver.common.by import By\nfrom selenium.webdriver.chrome.options import Options\nfrom selenium.webdriver.support.ui import WebDriverWait\nfrom selenium.webdriver.support import expected_conditions as EC\nimport time\nfrom datetime import datetime\n\n# =========================================================\n# 1. READ INSTRUCTION\n# =========================================================\nlog_messages = []\ntry:\n    first_item = _items[0]\n    payload = first_item['json'] if 'json' in first_item else first_item\n    \n    ROLE_SLUG = payload.get('role_slug', 'business-analyst')\n    ROLE_NAME = payload.get('role_name', 'Business Analyst')\n    TARGET_PAGE = int(payload.get('target_page', 1))\n    TARGET_INDEX = int(payload.get('target_index', 0))\n    \n    log_messages.append(f\"Input: Page {TARGET_PAGE}, Index {TARGET_INDEX}\")\nexcept Exception as e:\n    ROLE_SLUG = 'business-analyst'\n    ROLE_NAME = 'Business Analyst'\n    TARGET_PAGE = 1\n    TARGET_INDEX = 0\n    log_messages.append(f\"Input Error: {e}\")\n\n# =========================================================\n# 2. SELENIUM SETUP\n# =========================================================\nchrome_options = Options()\nchrome_options.add_argument(\"--headless\")\nchrome_options.add_argument(\"--no-sandbox\")\nchrome_options.add_argument(\"--disable-dev-shm-usage\")\nchrome_options.add_argument(\"--disable-gpu\")\n# Use a standard user agent to avoid bot detection\nchrome_options.add_argument(\"user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\")\n\ndriver = webdriver.Remote(\n    command_executor='http://selenium:4444/wd/hub',\n    options=chrome_options\n)\n\njob_data = {}\nstatus = \"success\"\n\ntry:\n    # 3. NAVIGATE TO LIST PAGE\n    url = f\"https://www.naukri.com/{ROLE_SLUG}-jobs-{TARGET_PAGE}\"\n    log_messages.append(f\"Navigating to {url}\")\n    driver.get(url)\n    \n    # Wait for cards\n    try:\n        WebDriverWait(driver, 10).until(\n            EC.presence_of_element_located((By.CSS_SELECTOR, \".srp-jobtuple-wrapper\"))\n        )\n    except:\n        log_messages.append(\"Timeout waiting for job list\")\n        status = \"skipped_timeout\"\n\n    # 4. FIND SPECIFIC CARD\n    cards = driver.find_elements(By.CSS_SELECTOR, \".srp-jobtuple-wrapper\")\n    log_messages.append(f\"Found {len(cards)} cards\")\n    \n    if len(cards) > TARGET_INDEX:\n        card = cards[TARGET_INDEX]\n        \n        # --- Helper to safely get text ---\n        def get_text(parent, selector):\n            try: return parent.find_element(By.CSS_SELECTOR, selector).text.strip()\n            except: return \"\"\n\n        # Extract List Info\n        job_id = card.get_attribute(\"data-job-id\")\n        title = get_text(card, \"a.title\")\n        company = get_text(card, \"a.comp-name\")\n        exp = get_text(card, \".expwdth\")\n        salary = get_text(card, \".sal-wrap .ni-job-tuple-icon-srp-rupee span\")\n        loc = get_text(card, \".locWdth\")\n        skills = get_text(card, \".tags-gt\")\n        short_desc = get_text(card, \".job-desc\")\n        \n        link = \"\"\n        try: link = card.find_element(By.CSS_SELECTOR, \"a.title\").get_attribute(\"href\")\n        except: pass\n        \n        full_desc = \"\"\n        \n        # 5. NAVIGATE TO DETAIL PAGE (Linear Flow)\n        if link:\n            log_messages.append(\"Navigating to details page...\")\n            try:\n                driver.get(link)\n                # Wait for description (Fast wait)\n                WebDriverWait(driver, 5).until(\n                    EC.presence_of_element_located((By.CSS_SELECTOR, \".styles_JDC__dang-inner-html__h0K4t, .job-details-container\"))\n                )\n                \n                # Extract Description\n                for sel in [\".styles_JDC__dang-inner-html__h0K4t\", \".job-details-container\", \".jd-container\", \".description\"]:\n                    try:\n                        el = driver.find_element(By.CSS_SELECTOR, sel)\n                        if el.text.strip():\n                            full_desc = el.text.strip()\n                            break\n                    except: continue\n            except Exception as e:\n                log_messages.append(f\"Detail scrape error: {str(e)}\")\n        \n        # 6. COMPILE DATA\n        final_desc = full_desc if full_desc else short_desc\n        \n        job_data = {\n            \"job_id\": job_id,\n            \"role\": ROLE_NAME,\n            \"title\": title,\n            \"company\": company,\n            \"experience\": exp,\n            \"salary\": salary,\n            \"location\": loc,\n            \"skills\": skills,\n            \"description\": final_desc,\n            \"link\": link,\n            \"scraped_date\": datetime.now().strftime(\"%Y-%m-%d\"),\n            \"debug_log\": \" | \".join(log_messages)\n        }\n        \n    else:\n        status = \"skipped_index_out_of_range\"\n        log_messages.append(\"Index exceeds available cards on page\")\n\nexcept Exception as e:\n    status = \"error\"\n    log_messages.append(f\"Critical Error: {str(e)}\")\n\nfinally:\n    driver.quit()\n\n# 7. OUTPUT\n# If we found a job, return it. If not, return a 'skipped' record so n8n sees output.\nif job_data:\n    return [job_data]\nelse:\n    # Return a dummy object so you can see the error in the output window\n    return [{\n        \"status\": status,\n        \"logs\": log_messages,\n        \"role\": ROLE_NAME, \n        \"target_page\": TARGET_PAGE\n    }]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2384,
        96
      ],
      "id": "b7514c6c-0ae0-4b6f-8cf7-5c41a8a5251e",
      "name": "Code in Python (Native)",
      "retryOnFail": false,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -2592,
        -128
      ],
      "id": "3b127728-b625-4e91-af11-845a23b52d97",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "jsCode": "// CONFIGURATION\nconst maxPages = 3;       // Scrape 3 Pages\nconst itemsPerPage = 20;  // 20 Jobs per page\n\n// GET INPUTS (From Telegram)\nconst inputData = $('Switch Route').item.json;\nconst roleSlug = inputData.role_slug || 'business-analyst'; // Fallback used only if testing manually\nconst roleName = inputData.role_name || 'Business Analyst';\n\nconst tasks = [];\n\n// GENERATE TASKS\n// Create instructions for Page 1 (0-19), Page 2 (0-19), Page 3 (0-19)\nfor (let page = 1; page <= maxPages; page++) {\n  for (let index = 0; index < itemsPerPage; index++) {\n    tasks.push({\n      json: {\n        role_slug: roleSlug,\n        role_name: roleName,\n        target_page: page,\n        target_index: index,\n        task_id: `${roleSlug}_p${page}_i${index}`\n      }\n    });\n  }\n}\n\nreturn tasks;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3072,
        -128
      ],
      "id": "53519265-0ae2-4a1e-a690-e3bbef6720c0",
      "name": "Work Generator"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "1d9c5013-d947-4ba2-a97b-9f4430e7338a",
              "leftValue": "={{ $json.job_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "fc7d79b4-694a-4d1f-a6af-b9ff57dd8b5f",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1680,
        80
      ],
      "id": "0957d84f-d8a2-49d0-9575-abf932c512d2",
      "name": "Is Not Empty"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE user_sessions SET current_state = 'IDLE', collected_data = '{}', updated_at = NOW() WHERE chat_id = {{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2256,
        -144
      ],
      "id": "bb97a8ba-d3dc-41a8-8274-57dece09e8fd",
      "name": "Set State: Finished",
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "text": "=âœ… **Data Collection Complete**\n\nThe market analysis for **{{ $('Switch Route').item.json.role_name }}** has been successfully gathered.\n\nðŸ” **Reference ID:** `{{ $('Calculate New ID').item.json.reference_id }}`\n\nâš ï¸ **Note:** Please save this Reference ID. \nThe raw data for this job role has been securely backed up under this ID. Your detailed analysis report will be generated and sent to you shortly.",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "ðŸ”™ Back to Analysis",
                    "additionalFields": {
                      "callback_data": "menu"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1248,
        -144
      ],
      "id": "ee6e1726-8824-44ac-9949-d584ba3b896e",
      "name": "Notify User: Scraping Complete",
      "webhookId": "69e16ce9-4b80-4a6e-a4f5-2093873532a9",
      "executeOnce": true,
      "credentials": {
        "telegramApi": {
          "id": "YgUKoloc6u1XLWhU",
          "name": "job analyst"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list",
          "cachedResultName": "public"
        },
        "table": {
          "__rl": true,
          "value": "job_postings",
          "mode": "list",
          "cachedResultName": "job_postings"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
            "job_id": "={{ $json.job_id }}",
            "role": "={{ $json.role }}",
            "title": "={{ $json.title }}",
            "company": "={{ $json.company }}",
            "experience": "={{ $json.experience }}",
            "salary": "={{ $json.salary }}",
            "location": "={{ $json.location }}",
            "skills": "={{ $json.skills }}",
            "description": "={{ $json.description }}",
            "link": "={{ $json.link }}",
            "scraped_date": "={{ $json.scraped_date }}",
            "updated_at": "={{ $now }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "job_id",
              "displayName": "job_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "role",
              "displayName": "role",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "company",
              "displayName": "company",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "experience",
              "displayName": "experience",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "salary",
              "displayName": "salary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "location",
              "displayName": "location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "skills",
              "displayName": "skills",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "description",
              "displayName": "description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "link",
              "displayName": "link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scraped_date",
              "displayName": "scraped_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1232,
        224
      ],
      "id": "271e5a43-8eef-45fc-a9e8-8faf818cd4e1",
      "name": "Save Jobs to DB (User Aware)1",
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "text": "=âœ… **Analysis Incomplete!**\n\nI have an error on scanning the job market for **{{ $('Switch Route').item.json.role_name }}**.\n\nðŸ“Š **Next Steps:**\n- Retry.",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "ðŸ”™ Back to Analysis",
                    "additionalFields": {
                      "callback_data": "menu"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2176,
        208
      ],
      "id": "d99def9e-40d2-40e1-9a47-c3ef2f735401",
      "name": "Notify User: Scraping Incomplete",
      "webhookId": "69e16ce9-4b80-4a6e-a4f5-2093873532a9",
      "executeOnce": true,
      "credentials": {
        "telegramApi": {
          "id": "YgUKoloc6u1XLWhU",
          "name": "job analyst"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE user_sessions SET current_state = 'IDLE', collected_data = '{}', updated_at = NOW() WHERE chat_id = {{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1984,
        208
      ],
      "id": "a43466b3-0b9a-46ab-8f3b-5d6e9a448dea",
      "name": "Set State: Finished2",
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE user_sessions \nSET current_state = 'IDLE', collected_data = '{}', updated_at = NOW() \nWHERE chat_id = {{ $('Telegram Trigger').item.json.callback_query.message.chat.id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1232,
        -960
      ],
      "id": "1751148e-c4b2-46cd-9e19-45b80d556f61",
      "name": "Reset State (Cancel)",
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "messageId": "={{ $('Telegram Trigger').item.json.callback_query.message.message_id }}",
        "text": "âŒ **Operation Cancelled**\n\nYou have exited the menu. \nType /start to begin a new search.",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1008,
        -960
      ],
      "id": "92283227-9019-4919-ab4d-8dfd7900fe9e",
      "name": "Notify: Cancelled",
      "webhookId": "a036d92a-8d26-4e20-ba85-27d124434a9e",
      "credentials": {
        "telegramApi": {
          "id": "YgUKoloc6u1XLWhU",
          "name": "job analyst"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "messageId": "={{ $('Telegram Trigger').item.json.callback_query.message.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "**JOB MARKET INTELLIGENCE**\n\nSelect a target job role to begin the analysis:",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Business Analyst",
                    "additionalFields": {
                      "callback_data": "business-analyst"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Data Analyst",
                    "additionalFields": {
                      "callback_data": "data-analyst"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Analytics Engineer",
                    "additionalFields": {
                      "callback_data": "analytics-engineer"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Automation Engineer",
                    "additionalFields": {
                      "callback_data": "automation-engineer"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Biz Auto Specialist",
                    "additionalFields": {
                      "callback_data": "business-automation-specialist"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Fintech Data Analyst",
                    "additionalFields": {
                      "callback_data": "fintech-data-analyst"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Tech Product Analyst",
                    "additionalFields": {
                      "callback_data": "technical-product-analyst"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Enter Custom Role...",
                    "additionalFields": {
                      "callback_data": "custom_role"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Close",
                    "additionalFields": {
                      "callback_data": "cancel"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1008,
        -1536
      ],
      "id": "599ed2a4-8d06-4956-9599-72f26e17f76d",
      "name": "Update to Main Menu",
      "webhookId": "f455ecc6-4b7c-484b-80c1-d4f23ca07a24",
      "credentials": {
        "telegramApi": {
          "id": "YgUKoloc6u1XLWhU",
          "name": "job analyst"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE user_sessions SET current_state = 'IDLE', collected_data = '{}' WHERE chat_id = {{ $('Telegram Trigger').item.json.callback_query.message.chat.id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1232,
        -1536
      ],
      "id": "1ca0d11e-e212-4030-aaed-b0280bc6d3cd",
      "name": "Reset State (Update Menu)",
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM user_sessions WHERE chat_id = {{ $json.message ? $json.message.chat.id : $json.callback_query.message.chat.id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2640,
        -1296
      ],
      "id": "4b49c793-5070-40e4-9e2c-d04f396ea701",
      "name": "Get User Session",
      "executeOnce": false,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ðŸ§  CENTRAL BRAIN: UPDATED\n// Handles 'menu2' for editing messages\n\nconst session = $input.item.json;\nconst state = session.current_state || 'IDLE';\n\nconst trigger = $('Telegram Trigger').item.json;\nconst callback = trigger.callback_query ? trigger.callback_query.data : null;\nconst text = trigger.message ? trigger.message.text : null;\n\n// --- 1. GLOBAL COMMANDS ---\nif (text === '/start' || callback === 'start_bot' || text === '/scrape') {\n  return { json: { route: 'SHOW_MENU' } };\n}\n\n// --- 2. BACK NAVIGATION (NEW) ---\n// If user clicks 'Back to Menu' inside a submenu, we EDIT the message\nif (callback === 'menu2' || callback === 'menu') {\n  return { json: { route: 'UPDATE_TO_MENU' } };\n}\n\n// --- 3. LOCKING MECHANISM ---\nif (state === 'SCRAPING_IN_PROGRESS') {\n  const expiry = session.collected_data ? session.collected_data.lock_expiry : null;\n  const now = new Date();\n  if (expiry && now < new Date(expiry)) {\n    return { json: { route: 'SEND_LOCKED_MESSAGE' } };\n  }\n}\n\n// --- 4. CANCEL ---\nif (callback === 'cancel') {\n  return { json: { route: 'CANCEL_OPERATION' } };\n}\n\n// --- 5. MENU SELECTION FLOW ---\nif (state === 'SELECTING_ROLE' || state === 'IDLE' || state === 'AWAITING_CUSTOM_ROLE') {\n  if (callback) {\n    if (callback === 'custom_role') {\n      return { json: { route: 'ASK_CUSTOM_ROLE' } };\n    }\n    // Standard Role Selection\n    return { \n      json: { \n        route: 'START_SCRAPE_JOB', \n        role_slug: callback,\n        role_name: callback.replace(/-/g, ' ').toUpperCase() \n      } \n    };\n  }\n}\n\n// --- 6. CUSTOM ROLE INPUT ---\nif (state === 'AWAITING_CUSTOM_ROLE') {\n  if (text) {\n    const slug = text.trim().toLowerCase().replace(/\\s+/g, '-');\n    return { \n      json: { \n        route: 'START_SCRAPE_JOB', \n        role_slug: slug,\n        role_name: text.toUpperCase() \n      } \n    };\n  }\n}\n\nreturn { json: { route: 'SHOW_MENU' } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1856,
        -1392
      ],
      "id": "7c5b01b9-099c-48b5-b8d4-d83481497d76",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.route }}",
                    "rightValue": "SHOW_MENU",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "74546da6-375f-4d88-8fbf-ee70e1df8c50"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SHOW MENU"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.route }}",
                    "rightValue": "UPDATE_TO_MENU",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "741ca277-0d78-4471-942f-0cfbb8678f9a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "UPDATE MENU"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.route }}",
                    "rightValue": "ASK_CUSTOM_ROLE",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "b683e2f0-3c0d-4fec-99eb-ef1894e2336a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ASK CUSTOM ROLE"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.route }}",
                    "rightValue": "SEND_LOCKED_MESSAGE",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8481304e-45c4-4648-9a6d-4faccbff2024"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "LOCKED"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.route }}",
                    "rightValue": "CANCEL_OPERATION",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "0facf284-4e7b-425b-a421-6b747760ce91"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CANCEL"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.route }}",
                    "rightValue": "START_SCRAPE_JOB",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "aae53bd3-0591-421b-80e4-481c7aa51460"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "START SCRAPE"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -1568,
        -1280
      ],
      "id": "87a6a545-9d29-46bd-b807-81469c0de124",
      "name": "Switch Route"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COUNT(*) AS active_count\nFROM user_sessions\nWHERE current_state = 'SCRAPING_IN_PROGRESS';\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2960,
        -1456
      ],
      "id": "3bd70b59-b079-4a83-8014-763ef46c3147",
      "name": "Global check",
      "executeOnce": false,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "89894b3c-f551-428e-a5f4-105e57e27ea9",
              "leftValue": "={{ $json.active_count }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2768,
        -1456
      ],
      "id": "6c83bd15-cf42-432a-8d16-51ec70c80ab8",
      "name": "If"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "text": "â³ System is currently processing another analysis. Please try again later.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2512,
        -1472
      ],
      "id": "bd5acd87-8668-422d-b60b-6f0fcda7902e",
      "name": "Stop's user to access",
      "webhookId": "c2cae626-7cdc-4e12-8d62-ccadc39139ef",
      "credentials": {
        "telegramApi": {
          "id": "YgUKoloc6u1XLWhU",
          "name": "job analyst"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "GDeQD6XpAGoHASTo",
          "mode": "list",
          "cachedResultUrl": "/workflow/GDeQD6XpAGoHASTo",
          "cachedResultName": "Job Market Analysis Engine"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_chat_id": "={{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
            "role_name": "={{ $('Switch Route').item.json.role_name }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "role_name",
              "displayName": "role_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -976,
        160
      ],
      "id": "3d869966-57bd-405f-96a0-1458fbac9388",
      "name": "Call 'Job Market Analysis Engine'"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM job_postings \nWHERE chat_id = {{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }}\nAND role = '{{ $('Switch Route').item.json.role_name }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -736,
        160
      ],
      "id": "190b8038-d0ad-4b82-b3b2-50aad99da37c",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COALESCE(MAX(reference_id), 0) as last_id FROM backup_job_postings;",
        "options": {}
      },
      "id": "270f2ef4-6f3a-489f-aca9-7a91a27442dd",
      "name": "Get Last Reference ID",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1952,
        -144
      ],
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the last ID from the database\nconst lastId = $input.item.json.last_id;\n\n// Increment by 1 to create a new Batch ID\nconst newId = lastId + 1;\n\nreturn {\n  json: {\n    reference_id: newId\n  }\n};"
      },
      "id": "2e806670-aabe-4036-8f0c-eba3d17544de",
      "name": "Calculate New ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1680,
        -144
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO backup_job_postings \n(chat_id, job_id, role, title, company, experience, salary, location, skills, description, link, scraped_date, created_at, updated_at, reference_id)\nSELECT \n    chat_id, \n    job_id, \n    role, \n    title, \n    company, \n    experience, \n    salary, \n    location, \n    skills, \n    description, \n    link, \n    scraped_date, \n    created_at, \n    updated_at,\n    {{ $('Calculate New ID').item.json.reference_id }} as reference_id\nFROM job_postings \nWHERE chat_id = {{ $('Telegram Trigger').item.json.message ? $('Telegram Trigger').item.json.message.chat.id : $('Telegram Trigger').item.json.callback_query.message.chat.id }};",
        "options": {}
      },
      "id": "f8908d1f-5c3b-4ab8-8873-d4f5b62151a3",
      "name": "Backup Data",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1456,
        -144
      ],
      "credentials": {
        "postgres": {
          "id": "huv0oVp6gAOYZofK",
          "name": "job_market_intelligence"
        }
      }
    },
    {
      "parameters": {
        "errorMessage": "No error.....\n\nâ³ System is currently processing another analysis Globally."
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        -2336,
        -1472
      ],
      "id": "87a91033-dccf-4ee9-8d96-6a6461a15bc3",
      "name": "Stop and Error"
    }
  ],
  "pinData": {
    "Telegram Trigger": [
      {
        "json": {
          "update_id": 156295689,
          "callback_query": {
            "id": "8219342241708078636",
            "from": {
              "id": 1913714744,
              "is_bot": false,
              "first_name": "Kumaravel",
              "last_name": "A",
              "username": "kumar_a_vel_a",
              "language_code": "en"
            },
            "message": {
              "message_id": 337,
              "from": {
                "id": 8573592965,
                "is_bot": true,
                "first_name": "Job Analyst",
                "username": "Job_Data_Analyst_BOT"
              },
              "chat": {
                "id": 1913714744,
                "first_name": "Kumaravel",
                "last_name": "A",
                "username": "kumar_a_vel_a",
                "type": "private"
              },
              "date": 1768581899,
              "text": "JOB MARKET INTELLIGENCE\n\nSelect a target job role to begin the analysis:",
              "reply_markup": {
                "inline_keyboard": [
                  [
                    {
                      "text": "Business Analyst",
                      "callback_data": "business-analyst"
                    }
                  ],
                  [
                    {
                      "text": "Data Analyst",
                      "callback_data": "data-analyst"
                    }
                  ],
                  [
                    {
                      "text": "Analytics Engineer",
                      "callback_data": "analytics-engineer"
                    }
                  ],
                  [
                    {
                      "text": "Automation Engineer",
                      "callback_data": "automation-engineer"
                    }
                  ],
                  [
                    {
                      "text": "Biz Auto Specialist",
                      "callback_data": "business-automation-specialist"
                    }
                  ],
                  [
                    {
                      "text": "Fintech Data Analyst",
                      "callback_data": "fintech-data-analyst"
                    }
                  ],
                  [
                    {
                      "text": "Tech Product Analyst",
                      "callback_data": "technical-product-analyst"
                    }
                  ],
                  [
                    {
                      "text": "Enter Custom Role...",
                      "callback_data": "custom_role"
                    }
                  ],
                  [
                    {
                      "text": "Close",
                      "callback_data": "cancel"
                    }
                  ]
                ]
              }
            },
            "chat_instance": "1585142255595531732",
            "data": "business-analyst"
          }
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Global check",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get User Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset State (IDLE)": {
      "main": [
        [
          {
            "node": "Send Role Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set State: Awaiting Input": {
      "main": [
        [
          {
            "node": "Ask Custom Role (UI)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set State: Scraping In Progress": {
      "main": [
        [
          {
            "node": "Send Confirmation Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Confirmation Message": {
      "main": [
        [
          {
            "node": "Set State: Scraping (1 Hour Lock)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in Python (Native)": {
      "main": [
        [
          {
            "node": "Is Not Empty",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify User: Scraping Incomplete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Set State: Finished",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in Python (Native)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Work Generator": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Not Empty": {
      "main": [
        [
          {
            "node": "Save Jobs to DB (User Aware)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set State: Finished": {
      "main": [
        [
          {
            "node": "Get Last Reference ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notify User: Scraping Complete": {
      "main": [
        [
          {
            "node": "Call 'Job Market Analysis Engine'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Jobs to DB (User Aware)1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notify User: Scraping Incomplete": {
      "main": [
        [
          {
            "node": "Set State: Finished2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset State (Cancel)": {
      "main": [
        [
          {
            "node": "Notify: Cancelled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset State (Update Menu)": {
      "main": [
        [
          {
            "node": "Update to Main Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User Session": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Switch Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Route": {
      "main": [
        [
          {
            "node": "Reset State (IDLE)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reset State (Update Menu)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set State: Awaiting Input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Locked Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reset State (Cancel)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set State: Scraping In Progress",
            "type": "main",
            "index": 0
          },
          {
            "node": "Work Generator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Global check": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Stop's user to access",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Stop's user to access": {
      "main": [
        [
          {
            "node": "Stop and Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'Job Market Analysis Engine'": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Last Reference ID": {
      "main": [
        [
          {
            "node": "Calculate New ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate New ID": {
      "main": [
        [
          {
            "node": "Backup Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Backup Data": {
      "main": [
        [
          {
            "node": "Notify User: Scraping Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "b2da85dd-289d-42ed-bda9-ed1a92e376ae",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9f5282353603576946fbff36b567871e629011b1abbfe72d7843b725a09ec2ca"
  },
  "id": "vm-BX1-aYdiivJiXx1FRu",
  "tags": []
}